# MicroCause

谢宇翔

[toc]



## 1.引言

- 微服务广泛应用
- 尽管跨微服务故障根源定位已经有了很好的研究，但是如何定位一个微服务中的故障根源从而快速缓解该微服务的问题还没有被研究。
- MicroCause融合了PCTS算法和集成了因果关系，时间顺序和监测数据优先级的TCORW算法。

## 2.介绍

- 对于微服务，通常有调用它的上游组件，并且它可以调用一些下游组件
- 微服务通常被部署在一个或多个容器或虚拟机上。通常，主要有三种类型的组件可能导致微服务故障：上游组件、下游组件、部署环境。
- 操作人员已经配置了一组指标，以连续监控每个微服务的性能（KPI），当KPI出现异常时，它通常表示由微服务的上游组件、下游组件或部署环境引起的微服务故障。通常，异常组件或部署环境可以通过一个或多个指标中的异常来反映。一个异常度量可以进一步说明为什么这个根本原因成分变得异常，因此，微服务故障的根本原因可以用一个异常度量来表示。
- 操作员通常会在发生微服务故障时手动定位根本原因度量。然而，由于KPI和度量之间的依赖关系大量且复杂，这种手动方式耗时、劳动密集型且容易出错，所以设计了MicroCause
- 挑战：
  - 传统的因果图构造方法是针对独立和同分布的(iid)数据设计的，它不能充分利用传播延迟。
  - 目前的随机游走算法是基于这样一个假设，即与异常KPI更相关的异常度量更有可能是根本原因，但在我们的场景中并不总是正确的。
- 解决方法：
  - 为了解决第一个挑战，设计了一种新的PCTS（路径条件时间序列）算法来学习充分利用传播延迟的测指标的依赖图。在PCTS中，首先采用改进的PC来学习每个时间点序列的因果图。然后生成两个时间序列之间的边，并生成一个失效因果图。
  - 为了解决第二个挑战，提出了一种新的面向时间原因的随机游走(TCORW)方法；利用此方法整合了3个信息：
    - 监测指标的因果关系
    - 指标的异常信息如：异常时间，异常等级
    - 基于领域知识获得的度量优先级

## 3.准备工作

- 微服务架构

  - 可复用性

- 问题声明

  - 故障和异常

    - 微服务故障是指微服务功能不佳，严重影响用户体验质量的事件。
    - 异常状态并不一定会导致故障

  - KPI和指标

    - 操作人员仔细配置微服务的指标集合，以持续监控应用程序的状态，快速定位故障的根本原因，并及时减轻故障，以保证用户体验的质量

    - 关键性能指标(KPI)和度量指标
    - 异常度量可能是指示微服务故障的异常KPI的潜在根本原因。然而，度量的异常并不一定会导致KPI的异常。

  - （失败指标？？？ Failure ticket）
    - 指示故障发生位置的ID，表示KPI变异常的KPI名字，以及显示故障发生时间的时间戳

  - 问题定义

- PC算法

  - 因果关系学习的目的是从数据中发现因果关系，观测数据中构建因果图的最流行的方法是PC算法

- 随机游走

  1. 构造图G，点集V和边集E，对于$e_{ij}\in E$，如果$v_i$是$v_j$的一个原因，就将$e_{ij}$设为1.

  2. 计算Q：

     1）前进

     2）后退

     3）原地不动，一个点的邻居都与异常节点的关系很弱，那么这个点很有可能就是根因。

  3. 归一化Q，得到结果记为$\bar Q_{ij}$

  4. 做随机游走，每条边的概率依据$\bar Q_{ij}$

## 4.挑战和设计概述

### 4.1挑战

MicroCause有两个主要部分，即旨在学习组件之间关系的因果图构造，和试图推断根本原因的随机游走。

- 挑战1：基于iid的因果图不能捕获传播延迟
- 挑战2：基于相关性的随机游走可能不能准确地定位根本原因

### 4.2 设计概述

1. 取故障前4小时数据
2. 将数据集用于基于为时间序列因果图学习提出的PCTS算法生成故障因果图。同时，数据集将被检查是否在异常检测模块中被检测出异常。
3. 以时间原因为导向的随机游走算法将基于故障因果图和指标的异常信息，给出失败的前N个潜在根本原因。

## 5.方法

### 5.1失败因果图学习（这里看的不是很懂）

使用了别人的成果---使用PC算法形成的API依赖图（他们称之为iid数据）

提出了基于改进PC算法的PCTS算法

步骤：

1. 对于有N个时间序列的的微服务架构A的数据集$I^i_t,t=0,....,T,i=1,...N$作为输入
2. 定义异常传播的最大间隔为$\Gamma_{max}$
3. 使用滑动窗口构造单独的测试样例，并初始化初代父母$\hat P(I^i_t)=(I_{t-1,...,I_{t-\Gamma_{max}}})$
4. 对于每个$I^i_{t-\Gamma}$,如果它与$I^i_t$无关，则去除它，直到无法再去除为止
5. 然而得到的因果图G，每个节点代表的是**时间点**
6. 我们需要的因果图G'，每个节点代表的应该是**指标（即错误的地方）**
7. PCTS将G变为G‘，将最终的失败原因图记为$G_{FCG}$,边图记为$E_{FCG}$

### 5.2异常检测

SPOT ，阈值，输出failure ticket

### 5.3基于时间原因的随机游走

TCORW的三个步骤

步骤1：原因导向随机游走；通过指标和kpi之间的因果关系来找到可能的根本原因。

计算矩阵Q的方法：1.前进。2.后退。3.原地不动。

步骤2：潜在的根本原因评分

步骤3：对根本原因排序

- 算法1（挺简单的，先看时间再看评分排序）

## 6.实验

这里没细看，都是做了一些对比实验

