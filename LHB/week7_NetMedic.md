# NetMedic

### Introduction

##### 研究目的

设计一个系统，实现对小型企业网络的故障诊断

表1:十个在企业网络中观察到的异常和识别的根因。

可以看到异常的范围很大，包括特定于应用程序的错误以及性能和可达性问题。

根因的范围也很大，包括bug、配置更改、过载和某些活动的副作用。

虽然为每一个问题设计解决方案可能很简单，但设计一个覆盖所有这些问题的综合系统却是一个挑战。

##### 前期调研

作者调研了一些故障案例，以理解对诊断系统的需求——应该检测的异常症状和应该识别的根因。

表2:

1.大多数问题报告都是针对单个应用程序的，因此，诊断系统必须能够监控每个应用程序

2.特定于应用程序的异常占了大多数情况。这些条件包括应用服务器返回错误代码、特性没有按预期工作以及大量请求失败等。因此有必要跟踪特定应用程序的运行状况。

3.显示故障的根本原因。在19%的情况下，应用程序配置不正确。然而，最大的原因是应用程序所依赖的环境中的其他一些配置元素。我们定义的其他配置相当广泛，包括正在运行的底层服务、防火墙配置、已安装的设备和设备驱动程序等。



小型企业网络是动态的。它们经历频繁的变化，既有有意的(例如，安装新的应用程序，升级软件或硬件)，也有无意的(例如，触发潜在的错误，自动更新)在大多数情况下，不正确的配置不是由于操作者的错误造成的。相反，在他们不知情的情况下，配置被软件更新或bug覆盖了。在许多其他情况下，配置更改是有意的，但操作人员没有意识到更改的影响。

每一个变化都会影响到网络中的许多组件，其中一些看起来可能是无关的。检测单个的变化是相当容易的，困难之处在于提取出组件之间的交互作用来定位特定异常的根因。



### 诊断思路

将网络建模为组件(如应用程序进程、主机和配置元素)之间的依赖图。如果源组件直接影响目标组件，则在两个组件之间存在有向边。依赖图可以包含循环（例如两个通信的进程相互依赖）。

#### 计算边的权值

（图2）

使用组件过去的联合行为来估计当前的影响。在组件状态的历史中搜索源组件的状态与其当前状态“相似”的时间段。如果在这些期间，终止组件通常处于与其当前状态相似的状态，那么很有可能它受到源组件的影响。如果不是，则源组件的当前状态可能不会影响目标组件。边权值是衡量D在这段时间内的状态与Dnow的相似程度。如果在历史中没有找到类似于Snow的状态，则会给边SD分配一个默认的高权重。

本质上使用条件概率Prob(D = Dnow |S = Snow)，并用其假设反映了因果关系。

#### 找出根因组件

根因组件具有以下性质：

1.其可见的状态变化可以解释观察到的效果

2.它的可见状态变化不能用其他组件的可见状态变化来解释

### 具体算法

#### 获取组件状态

·有许多方法可以将一个网络划分为多个组成部分。分区是由日志中出现的错误类型指导的——当前设计中的组件包括应用程序进程、计算机和网络路径，以及应用程序、计算机和防火墙的配置。机器组件包括硬件和操作系统。

·此外，还包括一个名为NbrSet (Neighbor set的缩写)的虚拟组件。NbrSet表示与某个进程进行通信的另一组组件的集体行为。它的状态变量表示基于服务器端端口交换的流量和聚合的响应时间等信息。在存在冗余服务器(例如DNS)的情况下，它有助于模拟它们对客户端进程的总体影响。类似地，它对一个服务器进程的所有客户机的集体影响进行建模。使用NbrSet而不是单独的依赖项可以让我们更准确地建模依赖项

·诊断的粒度由建模组件的粒度决定。例如，使用完整的网络路径作为一个组件意味着，在单个交换机的级别上，根因将无法被识别。

NetMedic定期将每个组件的状态捕获为多变量向量。按照一定的时间间隔进行存储。

例如表4存储的组件状态信息

#### 构建依赖图

将网络建模为一个组件之间的依赖图，其中从一个组件到它的每个直接依赖组件都有一条边。我们使用一组模板(每个组件类型一个模板)自动生成这个图。图4显示了我们当前定义的模板集。模板的中心有一个组件类型，周围环绕着其他直接影响它的组件类型。真实依赖图中的边对应于模板中的边。例如，如果一台机器的模板显示它依赖于它的进程，我们就从它的每个进程中引入一条边。

图4模版解释：

机器取决于它的进程和它的配置。应用程序进程取决于它的配置、它的NbrSet、它的主机以及该机器的配置。由于资源共享，一个进程依赖于机器上的其他进程，但是我们没有在模板中直接包含该依赖。对于非通信进程，这种依赖是间接的，由机器介导的。我们目前忽略不涉及交换IP数据包的进程间交互(例如，通过共享内存)。使用NbrSet捕获IP通信。进程的NbrSet取决于本地和远程防火墙配置、与之通信的进程以及网络路径。最后，两台机器之间的网络路径取决于向其注入流量的所有机器和其他流量的数量，即来自被监控网络之外的主机的流量。

#### 计算获取异常

利用正态分布
$$
erf({{v-u} \over {\sqrt{2}\sigma}})
$$
计算观测值与u之间间隔部分的面积的两倍。

如果这个面积大于0.8，就认为是异常状态值。

#### 计算边权值

设S和D为依赖边的源节点和目标节点。如果S或D是正常的，那么S不太可能影响D，我们给这条边分配一个低权值。由于计算路径权值涉及到边权值的相乘，所以当边权值为0时，在遇到错误时很脆弱。因此，我们在实验中使用0.1的最低边权值。

如果S和D都是异常的，我们利用它们的联合历史行为来确定边权值。我们首先将历史时间分为K个大小相等的块，每个块由一个或多个时间点组成。每个时间点就是在这一段时间中S与Snow状态最相近的时刻。然后我们计算这些时间内Dt和Dnow的平均相似度。相似度计算公式：


$$
E(S->D)={{\sum^K_{k=1}(1-|D_{tk}-D_{now}|) \times w_k} \over \sum^K_{k=1}w_k}
$$
wk为相对权重因子，指定wk = 1−|Stk−Snow|如果|Stk−Snow|≤δ;否则为0。排除了S与Snow差异超过δ的时间段。

如果历史中没有与Snow相似的状态，就把所有S->D标记为高权值。

#### 根因排序

考虑两个因素：

1.到前端节点的最大无环路径权值W(p)（路径权值是边权值的几何平均值。）提取出排名靠前的节点，进入第二步

2.计算每个可能的异常组件到其他所有节点的路径权值，重新排名。